[{"authorTime":"2019-01-12 01:43:41","codes":[{"authorDate":"2019-01-12 01:43:41","commitOrder":1,"curCode":"  public void testStoppedConsumeDuringCompletion() throws Exception {\n    SegmentCompletionProtocol.Response response;\n    Request.Params params;\n    final String reason = \"IAmLazy\";\n\n    \r\n    segmentCompletionMgr._secconds = 5;\n    params = new Request.Params().withInstanceId(s1).withOffset(s1Offset).withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr.segmentConsumed(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.HOLD);\n    \r\n    segmentCompletionMgr._secconds += 1;\n    params = new Request.Params().withInstanceId(s2).withOffset(s2Offset).withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr.segmentConsumed(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.HOLD);\n    \r\n    segmentCompletionMgr._secconds += 1;\n    params = new Request.Params().withInstanceId(s3).withOffset(s3Offset).withSegmentName(segmentNameStr).withReason(reason);\n    response = segmentCompletionMgr.segmentStoppedConsuming(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.PROCESSED);\n    Assert.assertEquals(new LLCSegmentName(segmentNameStr), segmentManager._stoppedSegmentName);\n    Assert.assertEquals(s3, segmentManager._stoppedInstance);\n    segmentManager._stoppedSegmentName = null;\n    segmentManager._stoppedInstance = null;\n\n    \r\n    segmentCompletionMgr._secconds += 1;\n    params = new Request.Params().withInstanceId(s1).withOffset(s1Offset).withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr.segmentConsumed(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.CATCH_UP);\n    \r\n    segmentCompletionMgr._secconds += 1;\n    params = new Request.Params().withInstanceId(s2).withOffset(s2Offset).withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr.segmentConsumed(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.COMMIT);\n    \r\n    segmentCompletionMgr._secconds += 1;\n    params = new Request.Params().withInstanceId(s3).withOffset(s2Offset).withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr.segmentConsumed(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.HOLD);\n    \r\n    segmentCompletionMgr._secconds += 1;\n    params = new Request.Params().withInstanceId(s2).withOffset(s2Offset).withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr.segmentCommitStart(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.COMMIT_CONTINUE);\n\n    segmentCompletionMgr._secconds += 5;\n    params = new Request.Params().withInstanceId(s2).withOffset(s2Offset).withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr.segmentCommitEnd(params, true, false);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.COMMIT_SUCCESS);\n\n    \r\n    Assert.assertFalse(fsmMap.containsKey(segmentNameStr));\n\n    \r\n    segmentCompletionMgr._secconds += 1;\n    params = new Request.Params().withInstanceId(s2).withOffset(s2Offset).withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr.segmentConsumed(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.KEEP);\n\n    \r\n    Assert.assertFalse(fsmMap.containsKey(segmentNameStr));\n  }\n","date":"2019-01-12 01:43:41","endLine":162,"groupId":"9358","id":1,"instanceNumber":1,"isCurCommit":0,"methodName":"testStoppedConsumeDuringCompletion","params":"()","path":"/mnt/clonedata/CloneManagementServer/ManagementServer/consistResult/result-pinot-10-0.7/blobInfo/CC_OUT/blobs/81/6fc49396df5ba19ac9cb07c05068b8350e49c1.src","preCode":"  public void testStoppedConsumeDuringCompletion() throws Exception {\n    SegmentCompletionProtocol.Response response;\n    Request.Params params;\n    final String reason = \"IAmLazy\";\n\n    \r\n    segmentCompletionMgr._secconds = 5;\n    params = new Request.Params().withInstanceId(s1).withOffset(s1Offset).withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr.segmentConsumed(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.HOLD);\n    \r\n    segmentCompletionMgr._secconds += 1;\n    params = new Request.Params().withInstanceId(s2).withOffset(s2Offset).withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr.segmentConsumed(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.HOLD);\n    \r\n    segmentCompletionMgr._secconds += 1;\n    params = new Request.Params().withInstanceId(s3).withOffset(s3Offset).withSegmentName(segmentNameStr).withReason(reason);\n    response = segmentCompletionMgr.segmentStoppedConsuming(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.PROCESSED);\n    Assert.assertEquals(new LLCSegmentName(segmentNameStr), segmentManager._stoppedSegmentName);\n    Assert.assertEquals(s3, segmentManager._stoppedInstance);\n    segmentManager._stoppedSegmentName = null;\n    segmentManager._stoppedInstance = null;\n\n    \r\n    segmentCompletionMgr._secconds += 1;\n    params = new Request.Params().withInstanceId(s1).withOffset(s1Offset).withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr.segmentConsumed(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.CATCH_UP);\n    \r\n    segmentCompletionMgr._secconds += 1;\n    params = new Request.Params().withInstanceId(s2).withOffset(s2Offset).withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr.segmentConsumed(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.COMMIT);\n    \r\n    segmentCompletionMgr._secconds += 1;\n    params = new Request.Params().withInstanceId(s3).withOffset(s2Offset).withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr.segmentConsumed(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.HOLD);\n    \r\n    segmentCompletionMgr._secconds += 1;\n    params = new Request.Params().withInstanceId(s2).withOffset(s2Offset).withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr.segmentCommitStart(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.COMMIT_CONTINUE);\n\n    segmentCompletionMgr._secconds += 5;\n    params = new Request.Params().withInstanceId(s2).withOffset(s2Offset).withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr.segmentCommitEnd(params, true, false);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.COMMIT_SUCCESS);\n\n    \r\n    Assert.assertFalse(fsmMap.containsKey(segmentNameStr));\n\n    \r\n    segmentCompletionMgr._secconds += 1;\n    params = new Request.Params().withInstanceId(s2).withOffset(s2Offset).withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr.segmentConsumed(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.KEEP);\n\n    \r\n    Assert.assertFalse(fsmMap.containsKey(segmentNameStr));\n  }\n","realPath":"pinot-controller/src/test/java/org/apache/pinot/controller/helix/core/realtime/SegmentCompletionTest.java","repoName":"pinot","snippetEndLine":0,"snippetStartLine":0,"startLine":100,"status":"B"},{"authorDate":"2019-01-12 01:43:41","commitOrder":1,"curCode":"  public void testFailedSlowCommit() throws Exception\n  {\n    SegmentCompletionProtocol.Response response;\n    Request.Params params;\n    final String tableName = new LLCSegmentName(segmentNameStr).getTableName();\n    \r\n    final long startTime = 5;\n    segmentCompletionMgr._secconds = startTime;\n    params = new Request.Params().withInstanceId(s1).withOffset(s1Offset).withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr.segmentConsumed(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.HOLD);\n    \r\n    segmentCompletionMgr._secconds += 1;\n    params = new Request.Params().withInstanceId(s2).withOffset(s2Offset).withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr.segmentConsumed(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.HOLD);\n    \r\n    segmentCompletionMgr._secconds += 1;\n    params = new Request.Params().withInstanceId(s3).withOffset(s3Offset).withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr.segmentConsumed(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.CATCH_UP);\n    Assert.assertEquals(response.getOffset(), s2Offset);\n    \r\n    segmentCompletionMgr._secconds += 1;\n    params = new Request.Params().withInstanceId(s1).withOffset(s1Offset).withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr.segmentConsumed(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.CATCH_UP);\n    \r\n    segmentCompletionMgr._secconds += 1;\n    params = new Request.Params().withInstanceId(s2).withOffset(s2Offset).withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr.segmentConsumed(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.COMMIT);\n    long commitTimeSec = response.getBuildTimeSeconds();\n    Assert.assertTrue(commitTimeSec > 0);\n\n    \r\n    segmentCompletionMgr._secconds = startTime + commitTimeSec - 1;\n    params = new Request.Params().withInstanceId(s2).withOffset(s2Offset).withSegmentName(segmentNameStr).withExtraTimeSec(\n        20);\n    response = segmentCompletionMgr.extendBuildTime(params);\n    Assert.assertEquals(response.getStatus(), ControllerResponseStatus.PROCESSED);\n    Assert.assertTrue((fsmMap.containsKey(segmentNameStr)));\n\n    \r\n    segmentCompletionMgr._secconds += 25;\n    params = new Request.Params().withInstanceId(s2).withOffset(s2Offset).withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr.segmentCommitStart(params);\n    Assert.assertEquals(response.getStatus(), ControllerResponseStatus.HOLD);\n    \r\n    Assert.assertFalse((fsmMap.containsKey(segmentNameStr)));\n    Assert.assertFalse(commitTimeMap.containsKey(tableName));\n  }\n","date":"2019-01-12 01:43:41","endLine":885,"groupId":"10715","id":2,"instanceNumber":2,"isCurCommit":0,"methodName":"testFailedSlowCommit","params":"()","path":"/mnt/clonedata/CloneManagementServer/ManagementServer/consistResult/result-pinot-10-0.7/blobInfo/CC_OUT/blobs/81/6fc49396df5ba19ac9cb07c05068b8350e49c1.src","preCode":"  public void testFailedSlowCommit() throws Exception\n  {\n    SegmentCompletionProtocol.Response response;\n    Request.Params params;\n    final String tableName = new LLCSegmentName(segmentNameStr).getTableName();\n    \r\n    final long startTime = 5;\n    segmentCompletionMgr._secconds = startTime;\n    params = new Request.Params().withInstanceId(s1).withOffset(s1Offset).withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr.segmentConsumed(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.HOLD);\n    \r\n    segmentCompletionMgr._secconds += 1;\n    params = new Request.Params().withInstanceId(s2).withOffset(s2Offset).withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr.segmentConsumed(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.HOLD);\n    \r\n    segmentCompletionMgr._secconds += 1;\n    params = new Request.Params().withInstanceId(s3).withOffset(s3Offset).withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr.segmentConsumed(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.CATCH_UP);\n    Assert.assertEquals(response.getOffset(), s2Offset);\n    \r\n    segmentCompletionMgr._secconds += 1;\n    params = new Request.Params().withInstanceId(s1).withOffset(s1Offset).withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr.segmentConsumed(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.CATCH_UP);\n    \r\n    segmentCompletionMgr._secconds += 1;\n    params = new Request.Params().withInstanceId(s2).withOffset(s2Offset).withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr.segmentConsumed(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.COMMIT);\n    long commitTimeSec = response.getBuildTimeSeconds();\n    Assert.assertTrue(commitTimeSec > 0);\n\n    \r\n    segmentCompletionMgr._secconds = startTime + commitTimeSec - 1;\n    params = new Request.Params().withInstanceId(s2).withOffset(s2Offset).withSegmentName(segmentNameStr).withExtraTimeSec(\n        20);\n    response = segmentCompletionMgr.extendBuildTime(params);\n    Assert.assertEquals(response.getStatus(), ControllerResponseStatus.PROCESSED);\n    Assert.assertTrue((fsmMap.containsKey(segmentNameStr)));\n\n    \r\n    segmentCompletionMgr._secconds += 25;\n    params = new Request.Params().withInstanceId(s2).withOffset(s2Offset).withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr.segmentCommitStart(params);\n    Assert.assertEquals(response.getStatus(), ControllerResponseStatus.HOLD);\n    \r\n    Assert.assertFalse((fsmMap.containsKey(segmentNameStr)));\n    Assert.assertFalse(commitTimeMap.containsKey(tableName));\n  }\n","realPath":"pinot-controller/src/test/java/org/apache/pinot/controller/helix/core/realtime/SegmentCompletionTest.java","repoName":"pinot","snippetEndLine":0,"snippetStartLine":0,"startLine":834,"status":"B"}],"commitId":"b497851f3406b72b7f36596c362e1fcbcb4a162a","commitMessage":"@@@Move all files in com.linkedin to org.apache (#3680)\n\n","date":"2019-01-12 01:43:41","modifiedFileCount":"0","status":"B","submitter":"Neha Pawar"},{"authorTime":"2019-01-12 01:43:41","codes":[{"authorDate":"2019-03-14 06:24:17","commitOrder":2,"curCode":"  public void testStoppedConsumeDuringCompletion()\n      throws Exception {\n    SegmentCompletionProtocol.Response response;\n    Request.Params params;\n    final String reason = \"IAmLazy\";\n\n    \r\n    segmentCompletionMgr._secconds = 5;\n    params = new Request.Params().withInstanceId(s1).withOffset(s1Offset).withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr.segmentConsumed(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.HOLD);\n    \r\n    segmentCompletionMgr._secconds += 1;\n    params = new Request.Params().withInstanceId(s2).withOffset(s2Offset).withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr.segmentConsumed(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.HOLD);\n    \r\n    segmentCompletionMgr._secconds += 1;\n    params =\n        new Request.Params().withInstanceId(s3).withOffset(s3Offset).withSegmentName(segmentNameStr).withReason(reason);\n    response = segmentCompletionMgr.segmentStoppedConsuming(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.PROCESSED);\n    Assert.assertEquals(new LLCSegmentName(segmentNameStr), segmentManager._stoppedSegmentName);\n    Assert.assertEquals(s3, segmentManager._stoppedInstance);\n    segmentManager._stoppedSegmentName = null;\n    segmentManager._stoppedInstance = null;\n\n    \r\n    segmentCompletionMgr._secconds += 1;\n    params = new Request.Params().withInstanceId(s1).withOffset(s1Offset).withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr.segmentConsumed(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.CATCH_UP);\n    \r\n    segmentCompletionMgr._secconds += 1;\n    params = new Request.Params().withInstanceId(s2).withOffset(s2Offset).withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr.segmentConsumed(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.COMMIT);\n    \r\n    segmentCompletionMgr._secconds += 1;\n    params = new Request.Params().withInstanceId(s3).withOffset(s2Offset).withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr.segmentConsumed(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.HOLD);\n    \r\n    segmentCompletionMgr._secconds += 1;\n    params = new Request.Params().withInstanceId(s2).withOffset(s2Offset).withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr.segmentCommitStart(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.COMMIT_CONTINUE);\n\n    segmentCompletionMgr._secconds += 5;\n    params = new Request.Params().withInstanceId(s2).withOffset(s2Offset).withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr.segmentCommitEnd(params, true, false,\n            CommittingSegmentDescriptor.fromSegmentCompletionReqParams(params));\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.COMMIT_SUCCESS);\n\n    \r\n    Assert.assertFalse(fsmMap.containsKey(segmentNameStr));\n\n    \r\n    segmentCompletionMgr._secconds += 1;\n    params = new Request.Params().withInstanceId(s2).withOffset(s2Offset).withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr.segmentConsumed(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.KEEP);\n\n    \r\n    Assert.assertFalse(fsmMap.containsKey(segmentNameStr));\n  }\n","date":"2019-03-14 06:24:17","endLine":169,"groupId":"9358","id":3,"instanceNumber":1,"isCurCommit":0,"methodName":"testStoppedConsumeDuringCompletion","params":"()","path":"/mnt/clonedata/CloneManagementServer/ManagementServer/consistResult/result-pinot-10-0.7/blobInfo/CC_OUT/blobs/3b/8503e7a981f9978934bb27afa19b3ea0d73261.src","preCode":"  public void testStoppedConsumeDuringCompletion()\n      throws Exception {\n    SegmentCompletionProtocol.Response response;\n    Request.Params params;\n    final String reason = \"IAmLazy\";\n\n    \r\n    segmentCompletionMgr._secconds = 5;\n    params = new Request.Params().withInstanceId(s1).withOffset(s1Offset).withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr.segmentConsumed(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.HOLD);\n    \r\n    segmentCompletionMgr._secconds += 1;\n    params = new Request.Params().withInstanceId(s2).withOffset(s2Offset).withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr.segmentConsumed(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.HOLD);\n    \r\n    segmentCompletionMgr._secconds += 1;\n    params =\n        new Request.Params().withInstanceId(s3).withOffset(s3Offset).withSegmentName(segmentNameStr).withReason(reason);\n    response = segmentCompletionMgr.segmentStoppedConsuming(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.PROCESSED);\n    Assert.assertEquals(new LLCSegmentName(segmentNameStr), segmentManager._stoppedSegmentName);\n    Assert.assertEquals(s3, segmentManager._stoppedInstance);\n    segmentManager._stoppedSegmentName = null;\n    segmentManager._stoppedInstance = null;\n\n    \r\n    segmentCompletionMgr._secconds += 1;\n    params = new Request.Params().withInstanceId(s1).withOffset(s1Offset).withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr.segmentConsumed(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.CATCH_UP);\n    \r\n    segmentCompletionMgr._secconds += 1;\n    params = new Request.Params().withInstanceId(s2).withOffset(s2Offset).withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr.segmentConsumed(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.COMMIT);\n    \r\n    segmentCompletionMgr._secconds += 1;\n    params = new Request.Params().withInstanceId(s3).withOffset(s2Offset).withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr.segmentConsumed(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.HOLD);\n    \r\n    segmentCompletionMgr._secconds += 1;\n    params = new Request.Params().withInstanceId(s2).withOffset(s2Offset).withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr.segmentCommitStart(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.COMMIT_CONTINUE);\n\n    segmentCompletionMgr._secconds += 5;\n    params = new Request.Params().withInstanceId(s2).withOffset(s2Offset).withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr.segmentCommitEnd(params, true, false);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.COMMIT_SUCCESS);\n\n    \r\n    Assert.assertFalse(fsmMap.containsKey(segmentNameStr));\n\n    \r\n    segmentCompletionMgr._secconds += 1;\n    params = new Request.Params().withInstanceId(s2).withOffset(s2Offset).withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr.segmentConsumed(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.KEEP);\n\n    \r\n    Assert.assertFalse(fsmMap.containsKey(segmentNameStr));\n  }\n","realPath":"pinot-controller/src/test/java/org/apache/pinot/controller/helix/core/realtime/SegmentCompletionTest.java","repoName":"pinot","snippetEndLine":0,"snippetStartLine":0,"startLine":104,"status":"M"},{"authorDate":"2019-01-12 01:43:41","commitOrder":2,"curCode":"  public void testFailedSlowCommit() throws Exception\n  {\n    SegmentCompletionProtocol.Response response;\n    Request.Params params;\n    final String tableName = new LLCSegmentName(segmentNameStr).getTableName();\n    \r\n    final long startTime = 5;\n    segmentCompletionMgr._secconds = startTime;\n    params = new Request.Params().withInstanceId(s1).withOffset(s1Offset).withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr.segmentConsumed(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.HOLD);\n    \r\n    segmentCompletionMgr._secconds += 1;\n    params = new Request.Params().withInstanceId(s2).withOffset(s2Offset).withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr.segmentConsumed(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.HOLD);\n    \r\n    segmentCompletionMgr._secconds += 1;\n    params = new Request.Params().withInstanceId(s3).withOffset(s3Offset).withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr.segmentConsumed(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.CATCH_UP);\n    Assert.assertEquals(response.getOffset(), s2Offset);\n    \r\n    segmentCompletionMgr._secconds += 1;\n    params = new Request.Params().withInstanceId(s1).withOffset(s1Offset).withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr.segmentConsumed(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.CATCH_UP);\n    \r\n    segmentCompletionMgr._secconds += 1;\n    params = new Request.Params().withInstanceId(s2).withOffset(s2Offset).withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr.segmentConsumed(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.COMMIT);\n    long commitTimeSec = response.getBuildTimeSeconds();\n    Assert.assertTrue(commitTimeSec > 0);\n\n    \r\n    segmentCompletionMgr._secconds = startTime + commitTimeSec - 1;\n    params = new Request.Params().withInstanceId(s2).withOffset(s2Offset).withSegmentName(segmentNameStr).withExtraTimeSec(\n        20);\n    response = segmentCompletionMgr.extendBuildTime(params);\n    Assert.assertEquals(response.getStatus(), ControllerResponseStatus.PROCESSED);\n    Assert.assertTrue((fsmMap.containsKey(segmentNameStr)));\n\n    \r\n    segmentCompletionMgr._secconds += 25;\n    params = new Request.Params().withInstanceId(s2).withOffset(s2Offset).withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr.segmentCommitStart(params);\n    Assert.assertEquals(response.getStatus(), ControllerResponseStatus.HOLD);\n    \r\n    Assert.assertFalse((fsmMap.containsKey(segmentNameStr)));\n    Assert.assertFalse(commitTimeMap.containsKey(tableName));\n  }\n","date":"2019-01-12 01:43:41","endLine":885,"groupId":"10715","id":4,"instanceNumber":2,"isCurCommit":0,"methodName":"testFailedSlowCommit","params":"()","path":"/mnt/clonedata/CloneManagementServer/ManagementServer/consistResult/result-pinot-10-0.7/blobInfo/CC_OUT/blobs/81/6fc49396df5ba19ac9cb07c05068b8350e49c1.src","preCode":"  public void testFailedSlowCommit() throws Exception\n  {\n    SegmentCompletionProtocol.Response response;\n    Request.Params params;\n    final String tableName = new LLCSegmentName(segmentNameStr).getTableName();\n    \r\n    final long startTime = 5;\n    segmentCompletionMgr._secconds = startTime;\n    params = new Request.Params().withInstanceId(s1).withOffset(s1Offset).withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr.segmentConsumed(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.HOLD);\n    \r\n    segmentCompletionMgr._secconds += 1;\n    params = new Request.Params().withInstanceId(s2).withOffset(s2Offset).withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr.segmentConsumed(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.HOLD);\n    \r\n    segmentCompletionMgr._secconds += 1;\n    params = new Request.Params().withInstanceId(s3).withOffset(s3Offset).withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr.segmentConsumed(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.CATCH_UP);\n    Assert.assertEquals(response.getOffset(), s2Offset);\n    \r\n    segmentCompletionMgr._secconds += 1;\n    params = new Request.Params().withInstanceId(s1).withOffset(s1Offset).withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr.segmentConsumed(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.CATCH_UP);\n    \r\n    segmentCompletionMgr._secconds += 1;\n    params = new Request.Params().withInstanceId(s2).withOffset(s2Offset).withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr.segmentConsumed(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.COMMIT);\n    long commitTimeSec = response.getBuildTimeSeconds();\n    Assert.assertTrue(commitTimeSec > 0);\n\n    \r\n    segmentCompletionMgr._secconds = startTime + commitTimeSec - 1;\n    params = new Request.Params().withInstanceId(s2).withOffset(s2Offset).withSegmentName(segmentNameStr).withExtraTimeSec(\n        20);\n    response = segmentCompletionMgr.extendBuildTime(params);\n    Assert.assertEquals(response.getStatus(), ControllerResponseStatus.PROCESSED);\n    Assert.assertTrue((fsmMap.containsKey(segmentNameStr)));\n\n    \r\n    segmentCompletionMgr._secconds += 25;\n    params = new Request.Params().withInstanceId(s2).withOffset(s2Offset).withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr.segmentCommitStart(params);\n    Assert.assertEquals(response.getStatus(), ControllerResponseStatus.HOLD);\n    \r\n    Assert.assertFalse((fsmMap.containsKey(segmentNameStr)));\n    Assert.assertFalse(commitTimeMap.containsKey(tableName));\n  }\n","realPath":"pinot-controller/src/test/java/org/apache/pinot/controller/helix/core/realtime/SegmentCompletionTest.java","repoName":"pinot","snippetEndLine":0,"snippetStartLine":0,"startLine":834,"status":"N"}],"commitId":"2a70bb913f006d52a55aa686a86464b9acf4473f","commitMessage":"@@@Pinot controller side change to enhance LLC segment metadata upload. (#3877)\n\n* Pinot controller side change to enhance LLC segment metadata upload.\n\n* Remove an unused lib.\n\n* Revise based on reviews.\n\n* Let the LLCSegmentCompletionHandlers handle the metadata extraction.\n\n* Clean up error case behaviors for metadata extraction based on review.\n\n* Add more logging for error cases based on review feedback.\n\n* Fix integration failure by passing the right segment location in controller for metadata extraction.\n\n* Use PinotFS to copy segment files for metadata extraction.\n\n* Construct segment file URI directly.\n\n* Further revision to address reviews.\n\n* (1)Remove the prefix java.net. (2) Add test to show the diff between Apache URI and java.net.URI.\n\n* Fix a comment typo.\n\n* Revise logging and lib inclusion based on reviews.\n\n* Return failure directly if there is no metadata file in the input form.\n\n* Refector the upload function based on Subu's comments.\n\n* Fix the log error level.\n\n* Apply Subba's refactoring and a few of my twigs.\n\n* Address reviewer feedbacks about format and error logs.\n\n* Fix an compilation error.\n\n* Fix style issues and eliminate a local method.\n\n* Fix redundant line.\n","date":"2019-03-14 06:24:17","modifiedFileCount":"7","status":"M","submitter":"Ting Chen"},{"authorTime":"2019-01-12 01:43:41","codes":[{"authorDate":"2019-07-19 04:17:27","commitOrder":3,"curCode":"  public void testStoppedConsumeDuringCompletion()\n      throws Exception {\n    SegmentCompletionProtocol.Response response;\n    Request.Params params;\n    final String reason = \"IAmLazy\";\n\n    \r\n    segmentCompletionMgr._secconds = 5;\n    params = new Request.Params().withInstanceId(s1).withOffset(s1Offset).withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr.segmentConsumed(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.HOLD);\n    \r\n    segmentCompletionMgr._secconds += 1;\n    params = new Request.Params().withInstanceId(s2).withOffset(s2Offset).withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr.segmentConsumed(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.HOLD);\n    \r\n    segmentCompletionMgr._secconds += 1;\n    params =\n        new Request.Params().withInstanceId(s3).withOffset(s3Offset).withSegmentName(segmentNameStr).withReason(reason);\n    response = segmentCompletionMgr.segmentStoppedConsuming(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.PROCESSED);\n    Assert.assertEquals(new LLCSegmentName(segmentNameStr), segmentManager._stoppedSegmentName);\n    Assert.assertEquals(s3, segmentManager._stoppedInstance);\n    segmentManager._stoppedSegmentName = null;\n    segmentManager._stoppedInstance = null;\n\n    \r\n    segmentCompletionMgr._secconds += 1;\n    params = new Request.Params().withInstanceId(s1).withOffset(s1Offset).withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr.segmentConsumed(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.CATCH_UP);\n    \r\n    segmentCompletionMgr._secconds += 1;\n    params = new Request.Params().withInstanceId(s2).withOffset(s2Offset).withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr.segmentConsumed(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.COMMIT);\n    \r\n    segmentCompletionMgr._secconds += 1;\n    params = new Request.Params().withInstanceId(s3).withOffset(s2Offset).withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr.segmentConsumed(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.HOLD);\n    \r\n    segmentCompletionMgr._secconds += 1;\n    params = new Request.Params().withInstanceId(s2).withOffset(s2Offset).withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr.segmentCommitStart(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.COMMIT_CONTINUE);\n\n    segmentCompletionMgr._secconds += 5;\n    params = new Request.Params().withInstanceId(s2).withOffset(s2Offset).withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr\n        .segmentCommitEnd(params, true, false, CommittingSegmentDescriptor.fromSegmentCompletionReqParams(params));\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.COMMIT_SUCCESS);\n\n    \r\n    Assert.assertFalse(fsmMap.containsKey(segmentNameStr));\n\n    \r\n    segmentCompletionMgr._secconds += 1;\n    params = new Request.Params().withInstanceId(s1).withOffset(s2Offset).withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr.segmentConsumed(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.KEEP);\n\n    \r\n    Assert.assertFalse(fsmMap.containsKey(segmentNameStr));\n  }\n","date":"2019-07-19 04:17:27","endLine":175,"groupId":"9358","id":5,"instanceNumber":1,"isCurCommit":0,"methodName":"testStoppedConsumeDuringCompletion","params":"()","path":"/mnt/clonedata/CloneManagementServer/ManagementServer/consistResult/result-pinot-10-0.7/blobInfo/CC_OUT/blobs/51/ddf67b8ab54e95de850a0d030ea0d48fb72833.src","preCode":"  public void testStoppedConsumeDuringCompletion()\n      throws Exception {\n    SegmentCompletionProtocol.Response response;\n    Request.Params params;\n    final String reason = \"IAmLazy\";\n\n    \r\n    segmentCompletionMgr._secconds = 5;\n    params = new Request.Params().withInstanceId(s1).withOffset(s1Offset).withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr.segmentConsumed(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.HOLD);\n    \r\n    segmentCompletionMgr._secconds += 1;\n    params = new Request.Params().withInstanceId(s2).withOffset(s2Offset).withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr.segmentConsumed(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.HOLD);\n    \r\n    segmentCompletionMgr._secconds += 1;\n    params =\n        new Request.Params().withInstanceId(s3).withOffset(s3Offset).withSegmentName(segmentNameStr).withReason(reason);\n    response = segmentCompletionMgr.segmentStoppedConsuming(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.PROCESSED);\n    Assert.assertEquals(new LLCSegmentName(segmentNameStr), segmentManager._stoppedSegmentName);\n    Assert.assertEquals(s3, segmentManager._stoppedInstance);\n    segmentManager._stoppedSegmentName = null;\n    segmentManager._stoppedInstance = null;\n\n    \r\n    segmentCompletionMgr._secconds += 1;\n    params = new Request.Params().withInstanceId(s1).withOffset(s1Offset).withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr.segmentConsumed(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.CATCH_UP);\n    \r\n    segmentCompletionMgr._secconds += 1;\n    params = new Request.Params().withInstanceId(s2).withOffset(s2Offset).withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr.segmentConsumed(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.COMMIT);\n    \r\n    segmentCompletionMgr._secconds += 1;\n    params = new Request.Params().withInstanceId(s3).withOffset(s2Offset).withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr.segmentConsumed(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.HOLD);\n    \r\n    segmentCompletionMgr._secconds += 1;\n    params = new Request.Params().withInstanceId(s2).withOffset(s2Offset).withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr.segmentCommitStart(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.COMMIT_CONTINUE);\n\n    segmentCompletionMgr._secconds += 5;\n    params = new Request.Params().withInstanceId(s2).withOffset(s2Offset).withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr\n        .segmentCommitEnd(params, true, false, CommittingSegmentDescriptor.fromSegmentCompletionReqParams(params));\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.COMMIT_SUCCESS);\n\n    \r\n    Assert.assertFalse(fsmMap.containsKey(segmentNameStr));\n\n    \r\n    segmentCompletionMgr._secconds += 1;\n    params = new Request.Params().withInstanceId(s2).withOffset(s2Offset).withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr.segmentConsumed(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.KEEP);\n\n    \r\n    Assert.assertFalse(fsmMap.containsKey(segmentNameStr));\n  }\n","realPath":"pinot-controller/src/test/java/org/apache/pinot/controller/helix/core/realtime/SegmentCompletionTest.java","repoName":"pinot","snippetEndLine":0,"snippetStartLine":0,"startLine":110,"status":"M"},{"authorDate":"2019-01-12 01:43:41","commitOrder":3,"curCode":"  public void testFailedSlowCommit() throws Exception\n  {\n    SegmentCompletionProtocol.Response response;\n    Request.Params params;\n    final String tableName = new LLCSegmentName(segmentNameStr).getTableName();\n    \r\n    final long startTime = 5;\n    segmentCompletionMgr._secconds = startTime;\n    params = new Request.Params().withInstanceId(s1).withOffset(s1Offset).withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr.segmentConsumed(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.HOLD);\n    \r\n    segmentCompletionMgr._secconds += 1;\n    params = new Request.Params().withInstanceId(s2).withOffset(s2Offset).withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr.segmentConsumed(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.HOLD);\n    \r\n    segmentCompletionMgr._secconds += 1;\n    params = new Request.Params().withInstanceId(s3).withOffset(s3Offset).withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr.segmentConsumed(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.CATCH_UP);\n    Assert.assertEquals(response.getOffset(), s2Offset);\n    \r\n    segmentCompletionMgr._secconds += 1;\n    params = new Request.Params().withInstanceId(s1).withOffset(s1Offset).withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr.segmentConsumed(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.CATCH_UP);\n    \r\n    segmentCompletionMgr._secconds += 1;\n    params = new Request.Params().withInstanceId(s2).withOffset(s2Offset).withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr.segmentConsumed(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.COMMIT);\n    long commitTimeSec = response.getBuildTimeSeconds();\n    Assert.assertTrue(commitTimeSec > 0);\n\n    \r\n    segmentCompletionMgr._secconds = startTime + commitTimeSec - 1;\n    params = new Request.Params().withInstanceId(s2).withOffset(s2Offset).withSegmentName(segmentNameStr).withExtraTimeSec(\n        20);\n    response = segmentCompletionMgr.extendBuildTime(params);\n    Assert.assertEquals(response.getStatus(), ControllerResponseStatus.PROCESSED);\n    Assert.assertTrue((fsmMap.containsKey(segmentNameStr)));\n\n    \r\n    segmentCompletionMgr._secconds += 25;\n    params = new Request.Params().withInstanceId(s2).withOffset(s2Offset).withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr.segmentCommitStart(params);\n    Assert.assertEquals(response.getStatus(), ControllerResponseStatus.HOLD);\n    \r\n    Assert.assertFalse((fsmMap.containsKey(segmentNameStr)));\n    Assert.assertFalse(commitTimeMap.containsKey(tableName));\n  }\n","date":"2019-01-12 01:43:41","endLine":885,"groupId":"10715","id":6,"instanceNumber":2,"isCurCommit":0,"methodName":"testFailedSlowCommit","params":"()","path":"/mnt/clonedata/CloneManagementServer/ManagementServer/consistResult/result-pinot-10-0.7/blobInfo/CC_OUT/blobs/81/6fc49396df5ba19ac9cb07c05068b8350e49c1.src","preCode":"  public void testFailedSlowCommit() throws Exception\n  {\n    SegmentCompletionProtocol.Response response;\n    Request.Params params;\n    final String tableName = new LLCSegmentName(segmentNameStr).getTableName();\n    \r\n    final long startTime = 5;\n    segmentCompletionMgr._secconds = startTime;\n    params = new Request.Params().withInstanceId(s1).withOffset(s1Offset).withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr.segmentConsumed(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.HOLD);\n    \r\n    segmentCompletionMgr._secconds += 1;\n    params = new Request.Params().withInstanceId(s2).withOffset(s2Offset).withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr.segmentConsumed(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.HOLD);\n    \r\n    segmentCompletionMgr._secconds += 1;\n    params = new Request.Params().withInstanceId(s3).withOffset(s3Offset).withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr.segmentConsumed(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.CATCH_UP);\n    Assert.assertEquals(response.getOffset(), s2Offset);\n    \r\n    segmentCompletionMgr._secconds += 1;\n    params = new Request.Params().withInstanceId(s1).withOffset(s1Offset).withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr.segmentConsumed(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.CATCH_UP);\n    \r\n    segmentCompletionMgr._secconds += 1;\n    params = new Request.Params().withInstanceId(s2).withOffset(s2Offset).withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr.segmentConsumed(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.COMMIT);\n    long commitTimeSec = response.getBuildTimeSeconds();\n    Assert.assertTrue(commitTimeSec > 0);\n\n    \r\n    segmentCompletionMgr._secconds = startTime + commitTimeSec - 1;\n    params = new Request.Params().withInstanceId(s2).withOffset(s2Offset).withSegmentName(segmentNameStr).withExtraTimeSec(\n        20);\n    response = segmentCompletionMgr.extendBuildTime(params);\n    Assert.assertEquals(response.getStatus(), ControllerResponseStatus.PROCESSED);\n    Assert.assertTrue((fsmMap.containsKey(segmentNameStr)));\n\n    \r\n    segmentCompletionMgr._secconds += 25;\n    params = new Request.Params().withInstanceId(s2).withOffset(s2Offset).withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr.segmentCommitStart(params);\n    Assert.assertEquals(response.getStatus(), ControllerResponseStatus.HOLD);\n    \r\n    Assert.assertFalse((fsmMap.containsKey(segmentNameStr)));\n    Assert.assertFalse(commitTimeMap.containsKey(tableName));\n  }\n","realPath":"pinot-controller/src/test/java/org/apache/pinot/controller/helix/core/realtime/SegmentCompletionTest.java","repoName":"pinot","snippetEndLine":0,"snippetStartLine":0,"startLine":834,"status":"N"}],"commitId":"cd579b1ad8a87a5ca1fde25d6ddef2ab23b750bd","commitMessage":"@@@Add comments and fix typo for the SegmentCompletionTest. (#4447)\n\n","date":"2019-07-19 04:17:27","modifiedFileCount":"1","status":"M","submitter":"Ting Chen"},{"authorTime":"2019-08-16 06:26:29","codes":[{"authorDate":"2019-08-16 06:26:29","commitOrder":4,"curCode":"  public void testStoppedConsumeDuringCompletion()\n      throws Exception {\n    SegmentCompletionProtocol.Response response;\n    Request.Params params;\n    final String reason = \"IAmLazy\";\n\n    \r\n    segmentCompletionMgr._seconds = 5;\n    params = new Request.Params().withInstanceId(s1).withOffset(s1Offset).withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr.segmentConsumed(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.HOLD);\n    \r\n    segmentCompletionMgr._seconds += 1;\n    params = new Request.Params().withInstanceId(s2).withOffset(s2Offset).withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr.segmentConsumed(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.HOLD);\n    \r\n    segmentCompletionMgr._seconds += 1;\n    params =\n        new Request.Params().withInstanceId(s3).withOffset(s3Offset).withSegmentName(segmentNameStr).withReason(reason);\n    response = segmentCompletionMgr.segmentStoppedConsuming(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.PROCESSED);\n    Assert.assertEquals(new LLCSegmentName(segmentNameStr), segmentManager._stoppedSegmentName);\n    Assert.assertEquals(s3, segmentManager._stoppedInstance);\n    segmentManager._stoppedSegmentName = null;\n    segmentManager._stoppedInstance = null;\n\n    \r\n    segmentCompletionMgr._seconds += 1;\n    params = new Request.Params().withInstanceId(s1).withOffset(s1Offset).withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr.segmentConsumed(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.CATCH_UP);\n    \r\n    segmentCompletionMgr._seconds += 1;\n    params = new Request.Params().withInstanceId(s2).withOffset(s2Offset).withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr.segmentConsumed(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.COMMIT);\n    \r\n    segmentCompletionMgr._seconds += 1;\n    params = new Request.Params().withInstanceId(s3).withOffset(s2Offset).withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr.segmentConsumed(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.HOLD);\n    \r\n    segmentCompletionMgr._seconds += 1;\n    params = new Request.Params().withInstanceId(s2).withOffset(s2Offset).withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr.segmentCommitStart(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.COMMIT_CONTINUE);\n\n    segmentCompletionMgr._seconds += 5;\n    params = new Request.Params().withInstanceId(s2).withOffset(s2Offset).withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr\n        .segmentCommitEnd(params, true, false, CommittingSegmentDescriptor.fromSegmentCompletionReqParams(params));\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.COMMIT_SUCCESS);\n\n    \r\n    Assert.assertFalse(fsmMap.containsKey(segmentNameStr));\n\n    \r\n    segmentCompletionMgr._seconds += 1;\n    params = new Request.Params().withInstanceId(s1).withOffset(s2Offset).withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr.segmentConsumed(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.KEEP);\n\n    \r\n    Assert.assertFalse(fsmMap.containsKey(segmentNameStr));\n  }\n","date":"2019-08-16 06:26:29","endLine":175,"groupId":"9358","id":7,"instanceNumber":1,"isCurCommit":0,"methodName":"testStoppedConsumeDuringCompletion","params":"()","path":"/mnt/clonedata/CloneManagementServer/ManagementServer/consistResult/result-pinot-10-0.7/blobInfo/CC_OUT/blobs/7d/d2944320e124366b1152f7c5e537661a06493b.src","preCode":"  public void testStoppedConsumeDuringCompletion()\n      throws Exception {\n    SegmentCompletionProtocol.Response response;\n    Request.Params params;\n    final String reason = \"IAmLazy\";\n\n    \r\n    segmentCompletionMgr._secconds = 5;\n    params = new Request.Params().withInstanceId(s1).withOffset(s1Offset).withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr.segmentConsumed(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.HOLD);\n    \r\n    segmentCompletionMgr._secconds += 1;\n    params = new Request.Params().withInstanceId(s2).withOffset(s2Offset).withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr.segmentConsumed(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.HOLD);\n    \r\n    segmentCompletionMgr._secconds += 1;\n    params =\n        new Request.Params().withInstanceId(s3).withOffset(s3Offset).withSegmentName(segmentNameStr).withReason(reason);\n    response = segmentCompletionMgr.segmentStoppedConsuming(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.PROCESSED);\n    Assert.assertEquals(new LLCSegmentName(segmentNameStr), segmentManager._stoppedSegmentName);\n    Assert.assertEquals(s3, segmentManager._stoppedInstance);\n    segmentManager._stoppedSegmentName = null;\n    segmentManager._stoppedInstance = null;\n\n    \r\n    segmentCompletionMgr._secconds += 1;\n    params = new Request.Params().withInstanceId(s1).withOffset(s1Offset).withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr.segmentConsumed(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.CATCH_UP);\n    \r\n    segmentCompletionMgr._secconds += 1;\n    params = new Request.Params().withInstanceId(s2).withOffset(s2Offset).withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr.segmentConsumed(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.COMMIT);\n    \r\n    segmentCompletionMgr._secconds += 1;\n    params = new Request.Params().withInstanceId(s3).withOffset(s2Offset).withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr.segmentConsumed(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.HOLD);\n    \r\n    segmentCompletionMgr._secconds += 1;\n    params = new Request.Params().withInstanceId(s2).withOffset(s2Offset).withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr.segmentCommitStart(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.COMMIT_CONTINUE);\n\n    segmentCompletionMgr._secconds += 5;\n    params = new Request.Params().withInstanceId(s2).withOffset(s2Offset).withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr\n        .segmentCommitEnd(params, true, false, CommittingSegmentDescriptor.fromSegmentCompletionReqParams(params));\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.COMMIT_SUCCESS);\n\n    \r\n    Assert.assertFalse(fsmMap.containsKey(segmentNameStr));\n\n    \r\n    segmentCompletionMgr._secconds += 1;\n    params = new Request.Params().withInstanceId(s1).withOffset(s2Offset).withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr.segmentConsumed(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.KEEP);\n\n    \r\n    Assert.assertFalse(fsmMap.containsKey(segmentNameStr));\n  }\n","realPath":"pinot-controller/src/test/java/org/apache/pinot/controller/helix/core/realtime/SegmentCompletionTest.java","repoName":"pinot","snippetEndLine":0,"snippetStartLine":0,"startLine":110,"status":"M"},{"authorDate":"2019-08-16 06:26:29","commitOrder":4,"curCode":"  public void testFailedSlowCommit()\n      throws Exception {\n    SegmentCompletionProtocol.Response response;\n    Request.Params params;\n    final String tableName = new LLCSegmentName(segmentNameStr).getTableName();\n    \r\n    final long startTime = 5;\n    segmentCompletionMgr._seconds = startTime;\n    params = new Request.Params().withInstanceId(s1).withOffset(s1Offset).withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr.segmentConsumed(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.HOLD);\n    \r\n    segmentCompletionMgr._seconds += 1;\n    params = new Request.Params().withInstanceId(s2).withOffset(s2Offset).withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr.segmentConsumed(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.HOLD);\n    \r\n    segmentCompletionMgr._seconds += 1;\n    params = new Request.Params().withInstanceId(s3).withOffset(s3Offset).withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr.segmentConsumed(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.CATCH_UP);\n    Assert.assertEquals(response.getOffset(), s2Offset);\n    \r\n    segmentCompletionMgr._seconds += 1;\n    params = new Request.Params().withInstanceId(s1).withOffset(s1Offset).withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr.segmentConsumed(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.CATCH_UP);\n    \r\n    segmentCompletionMgr._seconds += 1;\n    params = new Request.Params().withInstanceId(s2).withOffset(s2Offset).withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr.segmentConsumed(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.COMMIT);\n    long commitTimeSec = response.getBuildTimeSeconds();\n    Assert.assertTrue(commitTimeSec > 0);\n\n    \r\n    segmentCompletionMgr._seconds = startTime + commitTimeSec - 1;\n    params = new Request.Params().withInstanceId(s2).withOffset(s2Offset).withSegmentName(segmentNameStr)\n        .withExtraTimeSec(20);\n    response = segmentCompletionMgr.extendBuildTime(params);\n    Assert.assertEquals(response.getStatus(), ControllerResponseStatus.PROCESSED);\n    Assert.assertTrue((fsmMap.containsKey(segmentNameStr)));\n\n    \r\n    segmentCompletionMgr._seconds += 25;\n    params = new Request.Params().withInstanceId(s2).withOffset(s2Offset).withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr.segmentCommitStart(params);\n    Assert.assertEquals(response.getStatus(), ControllerResponseStatus.HOLD);\n    \r\n    Assert.assertFalse((fsmMap.containsKey(segmentNameStr)));\n    Assert.assertFalse(commitTimeMap.containsKey(tableName));\n  }\n","date":"2019-08-16 06:26:29","endLine":934,"groupId":"10715","id":8,"instanceNumber":2,"isCurCommit":0,"methodName":"testFailedSlowCommit","params":"()","path":"/mnt/clonedata/CloneManagementServer/ManagementServer/consistResult/result-pinot-10-0.7/blobInfo/CC_OUT/blobs/7d/d2944320e124366b1152f7c5e537661a06493b.src","preCode":"  public void testFailedSlowCommit()\n      throws Exception {\n    SegmentCompletionProtocol.Response response;\n    Request.Params params;\n    final String tableName = new LLCSegmentName(segmentNameStr).getTableName();\n    \r\n    final long startTime = 5;\n    segmentCompletionMgr._secconds = startTime;\n    params = new Request.Params().withInstanceId(s1).withOffset(s1Offset).withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr.segmentConsumed(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.HOLD);\n    \r\n    segmentCompletionMgr._secconds += 1;\n    params = new Request.Params().withInstanceId(s2).withOffset(s2Offset).withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr.segmentConsumed(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.HOLD);\n    \r\n    segmentCompletionMgr._secconds += 1;\n    params = new Request.Params().withInstanceId(s3).withOffset(s3Offset).withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr.segmentConsumed(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.CATCH_UP);\n    Assert.assertEquals(response.getOffset(), s2Offset);\n    \r\n    segmentCompletionMgr._secconds += 1;\n    params = new Request.Params().withInstanceId(s1).withOffset(s1Offset).withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr.segmentConsumed(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.CATCH_UP);\n    \r\n    segmentCompletionMgr._secconds += 1;\n    params = new Request.Params().withInstanceId(s2).withOffset(s2Offset).withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr.segmentConsumed(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.COMMIT);\n    long commitTimeSec = response.getBuildTimeSeconds();\n    Assert.assertTrue(commitTimeSec > 0);\n\n    \r\n    segmentCompletionMgr._secconds = startTime + commitTimeSec - 1;\n    params = new Request.Params().withInstanceId(s2).withOffset(s2Offset).withSegmentName(segmentNameStr)\n        .withExtraTimeSec(20);\n    response = segmentCompletionMgr.extendBuildTime(params);\n    Assert.assertEquals(response.getStatus(), ControllerResponseStatus.PROCESSED);\n    Assert.assertTrue((fsmMap.containsKey(segmentNameStr)));\n\n    \r\n    segmentCompletionMgr._secconds += 25;\n    params = new Request.Params().withInstanceId(s2).withOffset(s2Offset).withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr.segmentCommitStart(params);\n    Assert.assertEquals(response.getStatus(), ControllerResponseStatus.HOLD);\n    \r\n    Assert.assertFalse((fsmMap.containsKey(segmentNameStr)));\n    Assert.assertFalse(commitTimeMap.containsKey(tableName));\n  }\n","realPath":"pinot-controller/src/test/java/org/apache/pinot/controller/helix/core/realtime/SegmentCompletionTest.java","repoName":"pinot","snippetEndLine":0,"snippetStartLine":0,"startLine":883,"status":"M"}],"commitId":"4f8ffc760f5187883a7ea7561c536dca2d0957b8","commitMessage":"@@@[Controller Separation] Add logic for lead controller resource (#4323)\n\n* Add logic for leveraging lead controller resource\n\n* Add logic for lead controller resource on controller side\n\n* Remove API design out of this PR\n\n* Move murmur2 functions to an util class in pinot-common\n\n* Use resource config to check whether resource is enabled\n\n* Create a customized MasterSlaveStateModelFactory instead of inherating one from Helix\n\n* Check resource config is enabled from server","date":"2019-08-16 06:26:29","modifiedFileCount":"38","status":"M","submitter":"Jialiang Li"},{"authorTime":"2020-06-04 04:01:24","codes":[{"authorDate":"2020-06-04 04:01:24","commitOrder":5,"curCode":"  public void testStoppedConsumeDuringCompletion()\n      throws Exception {\n    SegmentCompletionProtocol.Response response;\n    Request.Params params;\n    final String reason = \"IAmLazy\";\n\n    \r\n    segmentCompletionMgr._seconds = 5;\n    params = new Request.Params().withInstanceId(s1).withStreamPartitionMsgOffset(s1Offset).withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr.segmentConsumed(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.HOLD);\n    \r\n    segmentCompletionMgr._seconds += 1;\n    params = new Request.Params().withInstanceId(s2).withStreamPartitionMsgOffset(s2Offset).withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr.segmentConsumed(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.HOLD);\n    \r\n    segmentCompletionMgr._seconds += 1;\n    params =\n        new Request.Params().withInstanceId(s3).withStreamPartitionMsgOffset(s3Offset).withSegmentName(segmentNameStr).withReason(reason);\n    response = segmentCompletionMgr.segmentStoppedConsuming(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.PROCESSED);\n    Assert.assertEquals(new LLCSegmentName(segmentNameStr), segmentManager._stoppedSegmentName);\n    Assert.assertEquals(s3, segmentManager._stoppedInstance);\n    segmentManager._stoppedSegmentName = null;\n    segmentManager._stoppedInstance = null;\n\n    \r\n    segmentCompletionMgr._seconds += 1;\n    params = new Request.Params().withInstanceId(s1).withStreamPartitionMsgOffset(s1Offset).withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr.segmentConsumed(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.CATCH_UP);\n    \r\n    segmentCompletionMgr._seconds += 1;\n    params = new Request.Params().withInstanceId(s2).withStreamPartitionMsgOffset(s2Offset).withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr.segmentConsumed(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.COMMIT);\n    \r\n    segmentCompletionMgr._seconds += 1;\n    params = new Request.Params().withInstanceId(s3).withStreamPartitionMsgOffset(s2Offset).withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr.segmentConsumed(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.HOLD);\n    \r\n    segmentCompletionMgr._seconds += 1;\n    params = new Request.Params().withInstanceId(s2).withStreamPartitionMsgOffset(s2Offset).withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr.segmentCommitStart(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.COMMIT_CONTINUE);\n\n    segmentCompletionMgr._seconds += 5;\n    params = new Request.Params().withInstanceId(s2).withStreamPartitionMsgOffset(s2Offset).withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr\n        .segmentCommitEnd(params, true, false, CommittingSegmentDescriptor.fromSegmentCompletionReqParams(params));\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.COMMIT_SUCCESS);\n\n    \r\n    Assert.assertFalse(fsmMap.containsKey(segmentNameStr));\n\n    \r\n    segmentCompletionMgr._seconds += 1;\n    params = new Request.Params().withInstanceId(s1).withStreamPartitionMsgOffset(s2Offset).withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr.segmentConsumed(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.KEEP);\n\n    \r\n    Assert.assertFalse(fsmMap.containsKey(segmentNameStr));\n  }\n","date":"2020-06-04 04:01:24","endLine":183,"groupId":"9358","id":9,"instanceNumber":1,"isCurCommit":0,"methodName":"testStoppedConsumeDuringCompletion","params":"()","path":"/mnt/clonedata/CloneManagementServer/ManagementServer/consistResult/result-pinot-10-0.7/blobInfo/CC_OUT/blobs/d8/dda562c50e259520148437a08d4acb79bff2dd.src","preCode":"  public void testStoppedConsumeDuringCompletion()\n      throws Exception {\n    SegmentCompletionProtocol.Response response;\n    Request.Params params;\n    final String reason = \"IAmLazy\";\n\n    \r\n    segmentCompletionMgr._seconds = 5;\n    params = new Request.Params().withInstanceId(s1).withOffset(s1Offset).withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr.segmentConsumed(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.HOLD);\n    \r\n    segmentCompletionMgr._seconds += 1;\n    params = new Request.Params().withInstanceId(s2).withOffset(s2Offset).withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr.segmentConsumed(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.HOLD);\n    \r\n    segmentCompletionMgr._seconds += 1;\n    params =\n        new Request.Params().withInstanceId(s3).withOffset(s3Offset).withSegmentName(segmentNameStr).withReason(reason);\n    response = segmentCompletionMgr.segmentStoppedConsuming(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.PROCESSED);\n    Assert.assertEquals(new LLCSegmentName(segmentNameStr), segmentManager._stoppedSegmentName);\n    Assert.assertEquals(s3, segmentManager._stoppedInstance);\n    segmentManager._stoppedSegmentName = null;\n    segmentManager._stoppedInstance = null;\n\n    \r\n    segmentCompletionMgr._seconds += 1;\n    params = new Request.Params().withInstanceId(s1).withOffset(s1Offset).withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr.segmentConsumed(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.CATCH_UP);\n    \r\n    segmentCompletionMgr._seconds += 1;\n    params = new Request.Params().withInstanceId(s2).withOffset(s2Offset).withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr.segmentConsumed(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.COMMIT);\n    \r\n    segmentCompletionMgr._seconds += 1;\n    params = new Request.Params().withInstanceId(s3).withOffset(s2Offset).withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr.segmentConsumed(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.HOLD);\n    \r\n    segmentCompletionMgr._seconds += 1;\n    params = new Request.Params().withInstanceId(s2).withOffset(s2Offset).withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr.segmentCommitStart(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.COMMIT_CONTINUE);\n\n    segmentCompletionMgr._seconds += 5;\n    params = new Request.Params().withInstanceId(s2).withOffset(s2Offset).withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr\n        .segmentCommitEnd(params, true, false, CommittingSegmentDescriptor.fromSegmentCompletionReqParams(params));\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.COMMIT_SUCCESS);\n\n    \r\n    Assert.assertFalse(fsmMap.containsKey(segmentNameStr));\n\n    \r\n    segmentCompletionMgr._seconds += 1;\n    params = new Request.Params().withInstanceId(s1).withOffset(s2Offset).withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr.segmentConsumed(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.KEEP);\n\n    \r\n    Assert.assertFalse(fsmMap.containsKey(segmentNameStr));\n  }\n","realPath":"pinot-controller/src/test/java/org/apache/pinot/controller/helix/core/realtime/SegmentCompletionTest.java","repoName":"pinot","snippetEndLine":0,"snippetStartLine":0,"startLine":118,"status":"M"},{"authorDate":"2020-06-04 04:01:24","commitOrder":5,"curCode":"  public void testFailedSlowCommit()\n      throws Exception {\n    SegmentCompletionProtocol.Response response;\n    Request.Params params;\n    final String tableName = new LLCSegmentName(segmentNameStr).getTableName();\n    \r\n    final long startTime = 5;\n    segmentCompletionMgr._seconds = startTime;\n    params = new Request.Params().withInstanceId(s1).withStreamPartitionMsgOffset(s1Offset).withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr.segmentConsumed(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.HOLD);\n    \r\n    segmentCompletionMgr._seconds += 1;\n    params = new Request.Params().withInstanceId(s2).withStreamPartitionMsgOffset(s2Offset).withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr.segmentConsumed(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.HOLD);\n    \r\n    segmentCompletionMgr._seconds += 1;\n    params = new Request.Params().withInstanceId(s3).withStreamPartitionMsgOffset(s3Offset).withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr.segmentConsumed(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.CATCH_UP);\n    verifyOffset(response, s2Offset);\n    \r\n    segmentCompletionMgr._seconds += 1;\n    params = new Request.Params().withInstanceId(s1).withStreamPartitionMsgOffset(s1Offset).withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr.segmentConsumed(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.CATCH_UP);\n    \r\n    segmentCompletionMgr._seconds += 1;\n    params = new Request.Params().withInstanceId(s2).withStreamPartitionMsgOffset(s2Offset).withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr.segmentConsumed(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.COMMIT);\n    long commitTimeSec = response.getBuildTimeSeconds();\n    Assert.assertTrue(commitTimeSec > 0);\n\n    \r\n    segmentCompletionMgr._seconds = startTime + commitTimeSec - 1;\n    params = new Request.Params().withInstanceId(s2).withStreamPartitionMsgOffset(s2Offset).withSegmentName(segmentNameStr)\n        .withExtraTimeSec(20);\n    response = segmentCompletionMgr.extendBuildTime(params);\n    Assert.assertEquals(response.getStatus(), ControllerResponseStatus.PROCESSED);\n    Assert.assertTrue((fsmMap.containsKey(segmentNameStr)));\n\n    \r\n    segmentCompletionMgr._seconds += 25;\n    params = new Request.Params().withInstanceId(s2).withStreamPartitionMsgOffset(s2Offset).withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr.segmentCommitStart(params);\n    Assert.assertEquals(response.getStatus(), ControllerResponseStatus.HOLD);\n    \r\n    Assert.assertFalse((fsmMap.containsKey(segmentNameStr)));\n    Assert.assertFalse(commitTimeMap.containsKey(tableName));\n  }\n","date":"2020-06-04 04:01:24","endLine":944,"groupId":"10658","id":10,"instanceNumber":2,"isCurCommit":0,"methodName":"testFailedSlowCommit","params":"()","path":"/mnt/clonedata/CloneManagementServer/ManagementServer/consistResult/result-pinot-10-0.7/blobInfo/CC_OUT/blobs/d8/dda562c50e259520148437a08d4acb79bff2dd.src","preCode":"  public void testFailedSlowCommit()\n      throws Exception {\n    SegmentCompletionProtocol.Response response;\n    Request.Params params;\n    final String tableName = new LLCSegmentName(segmentNameStr).getTableName();\n    \r\n    final long startTime = 5;\n    segmentCompletionMgr._seconds = startTime;\n    params = new Request.Params().withInstanceId(s1).withOffset(s1Offset).withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr.segmentConsumed(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.HOLD);\n    \r\n    segmentCompletionMgr._seconds += 1;\n    params = new Request.Params().withInstanceId(s2).withOffset(s2Offset).withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr.segmentConsumed(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.HOLD);\n    \r\n    segmentCompletionMgr._seconds += 1;\n    params = new Request.Params().withInstanceId(s3).withOffset(s3Offset).withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr.segmentConsumed(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.CATCH_UP);\n    Assert.assertEquals(response.getOffset(), s2Offset);\n    \r\n    segmentCompletionMgr._seconds += 1;\n    params = new Request.Params().withInstanceId(s1).withOffset(s1Offset).withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr.segmentConsumed(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.CATCH_UP);\n    \r\n    segmentCompletionMgr._seconds += 1;\n    params = new Request.Params().withInstanceId(s2).withOffset(s2Offset).withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr.segmentConsumed(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.COMMIT);\n    long commitTimeSec = response.getBuildTimeSeconds();\n    Assert.assertTrue(commitTimeSec > 0);\n\n    \r\n    segmentCompletionMgr._seconds = startTime + commitTimeSec - 1;\n    params = new Request.Params().withInstanceId(s2).withOffset(s2Offset).withSegmentName(segmentNameStr)\n        .withExtraTimeSec(20);\n    response = segmentCompletionMgr.extendBuildTime(params);\n    Assert.assertEquals(response.getStatus(), ControllerResponseStatus.PROCESSED);\n    Assert.assertTrue((fsmMap.containsKey(segmentNameStr)));\n\n    \r\n    segmentCompletionMgr._seconds += 25;\n    params = new Request.Params().withInstanceId(s2).withOffset(s2Offset).withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr.segmentCommitStart(params);\n    Assert.assertEquals(response.getStatus(), ControllerResponseStatus.HOLD);\n    \r\n    Assert.assertFalse((fsmMap.containsKey(segmentNameStr)));\n    Assert.assertFalse(commitTimeMap.containsKey(tableName));\n  }\n","realPath":"pinot-controller/src/test/java/org/apache/pinot/controller/helix/core/realtime/SegmentCompletionTest.java","repoName":"pinot","snippetEndLine":0,"snippetStartLine":0,"startLine":893,"status":"M"}],"commitId":"056c930c6e62bbcd4cd3e8c659e16e815532dc4c","commitMessage":"@@@Changed the segment commit protocol to send/receive streamPartitionMs? (#5486)\n\n* Changed the segment commit protocol to send/receive streamPartitionMsgOffset\n\nUpdated the segment commit protocol so that new element streamPartitionMsgOffset\nis populated in requests (as request parameters) and in response (as JSON string element)\n\nThe server side has been modified to send the 'streamPartitionMsgOffset' as well as we the\n'offset' parameters to the controller. The controller looks for and prefers streamPartitionMsgOffset\nbut falls back to offset if the streamPartitionMsgOffset is not there.\n\nThe controller side.  in the repsonse message.  populates both of the elements.  and the server on\nthe receiver side does likewise -- preferring streamPartitionMsgOffset.\n\nAll callers into the protocol module have been modified to NOT set the offset field. Instead. \nonly set the streamPartitionMsgOffset field. The 'offset' value will be derived from\nstreamPartitionMsgOffset.\n\nAdded a test to make sure that the controller always generates both elements. Such a test was not\npossible in the server side at this time.  so verified manually.\n\nManually ran LLCClusterIntergrationTest by disabling populating `streamPartitionMsgOffset` on the\nserver side (old server/new controller) and on the controller respons side (new server/old controller)\n\nIssue #5359\n\n* Addressed review comments","date":"2020-06-04 04:01:24","modifiedFileCount":"8","status":"M","submitter":"Subbu Subramaniam"},{"authorTime":"2020-06-10 00:28:08","codes":[{"authorDate":"2020-06-10 00:28:08","commitOrder":6,"curCode":"  public void testStoppedConsumeDuringCompletion()\n      throws Exception {\n    SegmentCompletionProtocol.Response response;\n    Request.Params params;\n    final String reason = \"IAmLazy\";\n\n    \r\n    segmentCompletionMgr._seconds = 5;\n    params = new Request.Params().withInstanceId(s1).withStreamPartitionMsgOffset(s1Offset.toString())\n        .withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr.segmentConsumed(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.HOLD);\n    \r\n    segmentCompletionMgr._seconds += 1;\n    params = new Request.Params().withInstanceId(s2).withStreamPartitionMsgOffset(s2Offset.toString()).\n        withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr.segmentConsumed(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.HOLD);\n    \r\n    segmentCompletionMgr._seconds += 1;\n    params = new Request.Params().withInstanceId(s3).withStreamPartitionMsgOffset(s3Offset.toString()).\n        withSegmentName(segmentNameStr).withReason(reason);\n    response = segmentCompletionMgr.segmentStoppedConsuming(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.PROCESSED);\n    Assert.assertEquals(new LLCSegmentName(segmentNameStr), segmentManager._stoppedSegmentName);\n    Assert.assertEquals(s3, segmentManager._stoppedInstance);\n    segmentManager._stoppedSegmentName = null;\n    segmentManager._stoppedInstance = null;\n\n    \r\n    segmentCompletionMgr._seconds += 1;\n    params = new Request.Params().withInstanceId(s1).withStreamPartitionMsgOffset(s1Offset.toString())\n        .withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr.segmentConsumed(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.CATCH_UP);\n    \r\n    segmentCompletionMgr._seconds += 1;\n    params = new Request.Params().withInstanceId(s2).withStreamPartitionMsgOffset(s2Offset.toString())\n        .withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr.segmentConsumed(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.COMMIT);\n    \r\n    segmentCompletionMgr._seconds += 1;\n    params = new Request.Params().withInstanceId(s3).withStreamPartitionMsgOffset(s2Offset.toString())\n        .withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr.segmentConsumed(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.HOLD);\n    \r\n    segmentCompletionMgr._seconds += 1;\n    params = new Request.Params().withInstanceId(s2).withStreamPartitionMsgOffset(s2Offset.toString()).\n        withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr.segmentCommitStart(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.COMMIT_CONTINUE);\n\n    segmentCompletionMgr._seconds += 5;\n    params = new Request.Params().withInstanceId(s2).withStreamPartitionMsgOffset(s2Offset.toString()).\n        withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr\n        .segmentCommitEnd(params, true, false, CommittingSegmentDescriptor.fromSegmentCompletionReqParams(params));\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.COMMIT_SUCCESS);\n\n    \r\n    Assert.assertFalse(fsmMap.containsKey(segmentNameStr));\n\n    \r\n    segmentCompletionMgr._seconds += 1;\n    params = new Request.Params().withInstanceId(s1).withStreamPartitionMsgOffset(s2Offset.toString()).\n        withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr.segmentConsumed(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.KEEP);\n\n    \r\n    Assert.assertFalse(fsmMap.containsKey(segmentNameStr));\n  }\n","date":"2020-06-10 00:28:08","endLine":200,"groupId":"9142","id":11,"instanceNumber":1,"isCurCommit":0,"methodName":"testStoppedConsumeDuringCompletion","params":"()","path":"/mnt/clonedata/CloneManagementServer/ManagementServer/consistResult/result-pinot-10-0.7/blobInfo/CC_OUT/blobs/dd/8afdb0b66b55185a3410eb8127ef48b8728a2c.src","preCode":"  public void testStoppedConsumeDuringCompletion()\n      throws Exception {\n    SegmentCompletionProtocol.Response response;\n    Request.Params params;\n    final String reason = \"IAmLazy\";\n\n    \r\n    segmentCompletionMgr._seconds = 5;\n    params = new Request.Params().withInstanceId(s1).withStreamPartitionMsgOffset(s1Offset).withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr.segmentConsumed(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.HOLD);\n    \r\n    segmentCompletionMgr._seconds += 1;\n    params = new Request.Params().withInstanceId(s2).withStreamPartitionMsgOffset(s2Offset).withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr.segmentConsumed(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.HOLD);\n    \r\n    segmentCompletionMgr._seconds += 1;\n    params =\n        new Request.Params().withInstanceId(s3).withStreamPartitionMsgOffset(s3Offset).withSegmentName(segmentNameStr).withReason(reason);\n    response = segmentCompletionMgr.segmentStoppedConsuming(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.PROCESSED);\n    Assert.assertEquals(new LLCSegmentName(segmentNameStr), segmentManager._stoppedSegmentName);\n    Assert.assertEquals(s3, segmentManager._stoppedInstance);\n    segmentManager._stoppedSegmentName = null;\n    segmentManager._stoppedInstance = null;\n\n    \r\n    segmentCompletionMgr._seconds += 1;\n    params = new Request.Params().withInstanceId(s1).withStreamPartitionMsgOffset(s1Offset).withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr.segmentConsumed(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.CATCH_UP);\n    \r\n    segmentCompletionMgr._seconds += 1;\n    params = new Request.Params().withInstanceId(s2).withStreamPartitionMsgOffset(s2Offset).withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr.segmentConsumed(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.COMMIT);\n    \r\n    segmentCompletionMgr._seconds += 1;\n    params = new Request.Params().withInstanceId(s3).withStreamPartitionMsgOffset(s2Offset).withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr.segmentConsumed(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.HOLD);\n    \r\n    segmentCompletionMgr._seconds += 1;\n    params = new Request.Params().withInstanceId(s2).withStreamPartitionMsgOffset(s2Offset).withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr.segmentCommitStart(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.COMMIT_CONTINUE);\n\n    segmentCompletionMgr._seconds += 5;\n    params = new Request.Params().withInstanceId(s2).withStreamPartitionMsgOffset(s2Offset).withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr\n        .segmentCommitEnd(params, true, false, CommittingSegmentDescriptor.fromSegmentCompletionReqParams(params));\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.COMMIT_SUCCESS);\n\n    \r\n    Assert.assertFalse(fsmMap.containsKey(segmentNameStr));\n\n    \r\n    segmentCompletionMgr._seconds += 1;\n    params = new Request.Params().withInstanceId(s1).withStreamPartitionMsgOffset(s2Offset).withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr.segmentConsumed(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.KEEP);\n\n    \r\n    Assert.assertFalse(fsmMap.containsKey(segmentNameStr));\n  }\n","realPath":"pinot-controller/src/test/java/org/apache/pinot/controller/helix/core/realtime/SegmentCompletionTest.java","repoName":"pinot","snippetEndLine":0,"snippetStartLine":0,"startLine":127,"status":"M"},{"authorDate":"2020-06-10 00:28:08","commitOrder":6,"curCode":"  public void testFailedSlowCommit()\n      throws Exception {\n    SegmentCompletionProtocol.Response response;\n    Request.Params params;\n    final String tableName = new LLCSegmentName(segmentNameStr).getTableName();\n    \r\n    final long startTime = 5;\n    segmentCompletionMgr._seconds = startTime;\n    params = new Request.Params().withInstanceId(s1).withStreamPartitionMsgOffset(s1Offset.toString()).withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr.segmentConsumed(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.HOLD);\n    \r\n    segmentCompletionMgr._seconds += 1;\n    params = new Request.Params().withInstanceId(s2).withStreamPartitionMsgOffset(s2Offset.toString()).withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr.segmentConsumed(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.HOLD);\n    \r\n    segmentCompletionMgr._seconds += 1;\n    params = new Request.Params().withInstanceId(s3).withStreamPartitionMsgOffset(s3Offset.toString()).withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr.segmentConsumed(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.CATCH_UP);\n    verifyOffset(response, s2Offset);\n    \r\n    segmentCompletionMgr._seconds += 1;\n    params = new Request.Params().withInstanceId(s1).withStreamPartitionMsgOffset(s1Offset.toString()).withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr.segmentConsumed(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.CATCH_UP);\n    \r\n    segmentCompletionMgr._seconds += 1;\n    params = new Request.Params().withInstanceId(s2).withStreamPartitionMsgOffset(s2Offset.toString()).withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr.segmentConsumed(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.COMMIT);\n    long commitTimeSec = response.getBuildTimeSeconds();\n    Assert.assertTrue(commitTimeSec > 0);\n\n    \r\n    segmentCompletionMgr._seconds = startTime + commitTimeSec - 1;\n    params = new Request.Params().withInstanceId(s2).withStreamPartitionMsgOffset(s2Offset.toString()).withSegmentName(segmentNameStr)\n        .withExtraTimeSec(20);\n    response = segmentCompletionMgr.extendBuildTime(params);\n    Assert.assertEquals(response.getStatus(), ControllerResponseStatus.PROCESSED);\n    Assert.assertTrue((fsmMap.containsKey(segmentNameStr)));\n\n    \r\n    segmentCompletionMgr._seconds += 25;\n    params = new Request.Params().withInstanceId(s2).withStreamPartitionMsgOffset(s2Offset.toString()).withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr.segmentCommitStart(params);\n    Assert.assertEquals(response.getStatus(), ControllerResponseStatus.HOLD);\n    \r\n    Assert.assertFalse((fsmMap.containsKey(segmentNameStr)));\n    Assert.assertFalse(commitTimeMap.containsKey(tableName));\n  }\n","date":"2020-06-10 00:28:08","endLine":994,"groupId":"17022","id":12,"instanceNumber":2,"isCurCommit":0,"methodName":"testFailedSlowCommit","params":"()","path":"/mnt/clonedata/CloneManagementServer/ManagementServer/consistResult/result-pinot-10-0.7/blobInfo/CC_OUT/blobs/dd/8afdb0b66b55185a3410eb8127ef48b8728a2c.src","preCode":"  public void testFailedSlowCommit()\n      throws Exception {\n    SegmentCompletionProtocol.Response response;\n    Request.Params params;\n    final String tableName = new LLCSegmentName(segmentNameStr).getTableName();\n    \r\n    final long startTime = 5;\n    segmentCompletionMgr._seconds = startTime;\n    params = new Request.Params().withInstanceId(s1).withStreamPartitionMsgOffset(s1Offset).withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr.segmentConsumed(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.HOLD);\n    \r\n    segmentCompletionMgr._seconds += 1;\n    params = new Request.Params().withInstanceId(s2).withStreamPartitionMsgOffset(s2Offset).withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr.segmentConsumed(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.HOLD);\n    \r\n    segmentCompletionMgr._seconds += 1;\n    params = new Request.Params().withInstanceId(s3).withStreamPartitionMsgOffset(s3Offset).withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr.segmentConsumed(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.CATCH_UP);\n    verifyOffset(response, s2Offset);\n    \r\n    segmentCompletionMgr._seconds += 1;\n    params = new Request.Params().withInstanceId(s1).withStreamPartitionMsgOffset(s1Offset).withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr.segmentConsumed(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.CATCH_UP);\n    \r\n    segmentCompletionMgr._seconds += 1;\n    params = new Request.Params().withInstanceId(s2).withStreamPartitionMsgOffset(s2Offset).withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr.segmentConsumed(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.COMMIT);\n    long commitTimeSec = response.getBuildTimeSeconds();\n    Assert.assertTrue(commitTimeSec > 0);\n\n    \r\n    segmentCompletionMgr._seconds = startTime + commitTimeSec - 1;\n    params = new Request.Params().withInstanceId(s2).withStreamPartitionMsgOffset(s2Offset).withSegmentName(segmentNameStr)\n        .withExtraTimeSec(20);\n    response = segmentCompletionMgr.extendBuildTime(params);\n    Assert.assertEquals(response.getStatus(), ControllerResponseStatus.PROCESSED);\n    Assert.assertTrue((fsmMap.containsKey(segmentNameStr)));\n\n    \r\n    segmentCompletionMgr._seconds += 25;\n    params = new Request.Params().withInstanceId(s2).withStreamPartitionMsgOffset(s2Offset).withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr.segmentCommitStart(params);\n    Assert.assertEquals(response.getStatus(), ControllerResponseStatus.HOLD);\n    \r\n    Assert.assertFalse((fsmMap.containsKey(segmentNameStr)));\n    Assert.assertFalse(commitTimeMap.containsKey(tableName));\n  }\n","realPath":"pinot-controller/src/test/java/org/apache/pinot/controller/helix/core/realtime/SegmentCompletionTest.java","repoName":"pinot","snippetEndLine":0,"snippetStartLine":0,"startLine":943,"status":"M"}],"commitId":"957b28dbdee7cc90bb272be50ea2db6f28c99e53","commitMessage":"@@@Moved StreamPartitionMsgOffset to be an interface (#5506)\n\n* Moved StreamPartitionMsgOffset to be an interface\n\n- Changed StreamPartitionMsgOffset class to be an interface.\n- Introduced a LongMsgOffsetFactory class that can be used for Kafka. Other\n  streams will need to provide their own factory to create offsets of\n  various types. Keeping LongMsgOffsetFactory in spi.  so we can also use\n  it in tests. Alternative was to introduce this for each test.  but implement\n  one in kafka that does the same thing.\n- Introduced a new config 'stream.<type>.partition.offset.factory.class.name'\n  Stream providers need to set the offset factory class with this config key.\n- All classes now use StreamPartitionMsgOffset instead of 'long'.  except for\n  cases where the offset is received from the stream or the offset is being\n  read or written to persistent zk metadata.\n- Marked TODOs explicity on items still to be done to complete impleemntation\n  of generic offsets.\n\nIssue #5359\n\n* Enabled parsing stream partition msg offset in protocol\n\nAnd also added a backward cmpatibility test\n\n* Fix unit test failure","date":"2020-06-10 00:28:08","modifiedFileCount":"24","status":"M","submitter":"Subbu Subramaniam"},{"authorTime":"2021-08-21 17:02:19","codes":[{"authorDate":"2021-08-21 17:02:19","commitOrder":7,"curCode":"  public void testStoppedConsumeDuringCompletion()\n      throws Exception {\n    SegmentCompletionProtocol.Response response;\n    Request.Params params;\n    final String reason = \"IAmLazy\";\n\n    \r\n    _segmentCompletionMgr._seconds = 5;\n    params = new Request.Params().withInstanceId(S_1).withStreamPartitionMsgOffset(_s1Offset.toString())\n        .withSegmentName(_segmentNameStr);\n    response = _segmentCompletionMgr.segmentConsumed(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.HOLD);\n    \r\n    _segmentCompletionMgr._seconds += 1;\n    params = new Request.Params().withInstanceId(S_2).withStreamPartitionMsgOffset(_s2Offset.toString())\n        .withSegmentName(_segmentNameStr);\n    response = _segmentCompletionMgr.segmentConsumed(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.HOLD);\n    \r\n    _segmentCompletionMgr._seconds += 1;\n    params = new Request.Params().withInstanceId(S_3).withStreamPartitionMsgOffset(_s3Offset.toString())\n        .withSegmentName(_segmentNameStr).withReason(reason);\n    response = _segmentCompletionMgr.segmentStoppedConsuming(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.PROCESSED);\n    Assert.assertEquals(new LLCSegmentName(_segmentNameStr), _segmentManager._stoppedSegmentName);\n    Assert.assertEquals(S_3, _segmentManager._stoppedInstance);\n    _segmentManager._stoppedSegmentName = null;\n    _segmentManager._stoppedInstance = null;\n\n    \r\n    _segmentCompletionMgr._seconds += 1;\n    params = new Request.Params().withInstanceId(S_1).withStreamPartitionMsgOffset(_s1Offset.toString())\n        .withSegmentName(_segmentNameStr);\n    response = _segmentCompletionMgr.segmentConsumed(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.CATCH_UP);\n    \r\n    _segmentCompletionMgr._seconds += 1;\n    params = new Request.Params().withInstanceId(S_2).withStreamPartitionMsgOffset(_s2Offset.toString())\n        .withSegmentName(_segmentNameStr);\n    response = _segmentCompletionMgr.segmentConsumed(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.COMMIT);\n    \r\n    _segmentCompletionMgr._seconds += 1;\n    params = new Request.Params().withInstanceId(S_3).withStreamPartitionMsgOffset(_s2Offset.toString())\n        .withSegmentName(_segmentNameStr);\n    response = _segmentCompletionMgr.segmentConsumed(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.HOLD);\n    \r\n    _segmentCompletionMgr._seconds += 1;\n    params = new Request.Params().withInstanceId(S_2).withStreamPartitionMsgOffset(_s2Offset.toString())\n        .withSegmentName(_segmentNameStr);\n    response = _segmentCompletionMgr.segmentCommitStart(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.COMMIT_CONTINUE);\n\n    _segmentCompletionMgr._seconds += 5;\n    params = new Request.Params().withInstanceId(S_2).withStreamPartitionMsgOffset(_s2Offset.toString())\n        .withSegmentName(_segmentNameStr);\n    response = _segmentCompletionMgr\n        .segmentCommitEnd(params, true, false, CommittingSegmentDescriptor.fromSegmentCompletionReqParams(params));\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.COMMIT_SUCCESS);\n\n    \r\n    Assert.assertFalse(_fsmMap.containsKey(_segmentNameStr));\n\n    \r\n    _segmentCompletionMgr._seconds += 1;\n    params = new Request.Params().withInstanceId(S_1).withStreamPartitionMsgOffset(_s2Offset.toString())\n        .withSegmentName(_segmentNameStr);\n    response = _segmentCompletionMgr.segmentConsumed(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.KEEP);\n\n    \r\n    Assert.assertFalse(_fsmMap.containsKey(_segmentNameStr));\n  }\n","date":"2021-08-21 17:02:19","endLine":200,"groupId":"101466","id":13,"instanceNumber":1,"isCurCommit":1,"methodName":"testStoppedConsumeDuringCompletion","params":"()","path":"/mnt/clonedata/CloneManagementServer/ManagementServer/consistResult/result-pinot-10-0.7/blobInfo/CC_OUT/blobs/f5/2cc2d924ceea6617515aa279dcc84da724f008.src","preCode":"  public void testStoppedConsumeDuringCompletion()\n      throws Exception {\n    SegmentCompletionProtocol.Response response;\n    Request.Params params;\n    final String reason = \"IAmLazy\";\n\n    \r\n    segmentCompletionMgr._seconds = 5;\n    params = new Request.Params().withInstanceId(s1).withStreamPartitionMsgOffset(s1Offset.toString())\n        .withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr.segmentConsumed(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.HOLD);\n    \r\n    segmentCompletionMgr._seconds += 1;\n    params = new Request.Params().withInstanceId(s2).withStreamPartitionMsgOffset(s2Offset.toString())\n        .withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr.segmentConsumed(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.HOLD);\n    \r\n    segmentCompletionMgr._seconds += 1;\n    params = new Request.Params().withInstanceId(s3).withStreamPartitionMsgOffset(s3Offset.toString())\n        .withSegmentName(segmentNameStr).withReason(reason);\n    response = segmentCompletionMgr.segmentStoppedConsuming(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.PROCESSED);\n    Assert.assertEquals(new LLCSegmentName(segmentNameStr), segmentManager._stoppedSegmentName);\n    Assert.assertEquals(s3, segmentManager._stoppedInstance);\n    segmentManager._stoppedSegmentName = null;\n    segmentManager._stoppedInstance = null;\n\n    \r\n    segmentCompletionMgr._seconds += 1;\n    params = new Request.Params().withInstanceId(s1).withStreamPartitionMsgOffset(s1Offset.toString())\n        .withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr.segmentConsumed(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.CATCH_UP);\n    \r\n    segmentCompletionMgr._seconds += 1;\n    params = new Request.Params().withInstanceId(s2).withStreamPartitionMsgOffset(s2Offset.toString())\n        .withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr.segmentConsumed(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.COMMIT);\n    \r\n    segmentCompletionMgr._seconds += 1;\n    params = new Request.Params().withInstanceId(s3).withStreamPartitionMsgOffset(s2Offset.toString())\n        .withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr.segmentConsumed(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.HOLD);\n    \r\n    segmentCompletionMgr._seconds += 1;\n    params = new Request.Params().withInstanceId(s2).withStreamPartitionMsgOffset(s2Offset.toString())\n        .withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr.segmentCommitStart(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.COMMIT_CONTINUE);\n\n    segmentCompletionMgr._seconds += 5;\n    params = new Request.Params().withInstanceId(s2).withStreamPartitionMsgOffset(s2Offset.toString())\n        .withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr\n        .segmentCommitEnd(params, true, false, CommittingSegmentDescriptor.fromSegmentCompletionReqParams(params));\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.COMMIT_SUCCESS);\n\n    \r\n    Assert.assertFalse(fsmMap.containsKey(segmentNameStr));\n\n    \r\n    segmentCompletionMgr._seconds += 1;\n    params = new Request.Params().withInstanceId(s1).withStreamPartitionMsgOffset(s2Offset.toString())\n        .withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr.segmentConsumed(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.KEEP);\n\n    \r\n    Assert.assertFalse(fsmMap.containsKey(segmentNameStr));\n  }\n","realPath":"pinot-controller/src/test/java/org/apache/pinot/controller/helix/core/realtime/SegmentCompletionTest.java","repoName":"pinot","snippetEndLine":0,"snippetStartLine":0,"startLine":127,"status":"M"},{"authorDate":"2021-08-21 17:02:19","commitOrder":7,"curCode":"  public void testFailedSlowCommit()\n      throws Exception {\n    SegmentCompletionProtocol.Response response;\n    Request.Params params;\n    final String tableName = new LLCSegmentName(_segmentNameStr).getTableName();\n    \r\n    final long startTime = 5;\n    _segmentCompletionMgr._seconds = startTime;\n    params = new Request.Params().withInstanceId(S_1).withStreamPartitionMsgOffset(_s1Offset.toString())\n        .withSegmentName(_segmentNameStr);\n    response = _segmentCompletionMgr.segmentConsumed(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.HOLD);\n    \r\n    _segmentCompletionMgr._seconds += 1;\n    params = new Request.Params().withInstanceId(S_2).withStreamPartitionMsgOffset(_s2Offset.toString())\n        .withSegmentName(_segmentNameStr);\n    response = _segmentCompletionMgr.segmentConsumed(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.HOLD);\n    \r\n    _segmentCompletionMgr._seconds += 1;\n    params = new Request.Params().withInstanceId(S_3).withStreamPartitionMsgOffset(_s3Offset.toString())\n        .withSegmentName(_segmentNameStr);\n    response = _segmentCompletionMgr.segmentConsumed(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.CATCH_UP);\n    verifyOffset(response, _s2Offset);\n    \r\n    _segmentCompletionMgr._seconds += 1;\n    params = new Request.Params().withInstanceId(S_1).withStreamPartitionMsgOffset(_s1Offset.toString())\n        .withSegmentName(_segmentNameStr);\n    response = _segmentCompletionMgr.segmentConsumed(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.CATCH_UP);\n    \r\n    _segmentCompletionMgr._seconds += 1;\n    params = new Request.Params().withInstanceId(S_2).withStreamPartitionMsgOffset(_s2Offset.toString())\n        .withSegmentName(_segmentNameStr);\n    response = _segmentCompletionMgr.segmentConsumed(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.COMMIT);\n    long commitTimeSec = response.getBuildTimeSeconds();\n    Assert.assertTrue(commitTimeSec > 0);\n\n    \r\n    _segmentCompletionMgr._seconds = startTime + commitTimeSec - 1;\n    params = new Request.Params().withInstanceId(S_2).withStreamPartitionMsgOffset(_s2Offset.toString())\n        .withSegmentName(_segmentNameStr).withExtraTimeSec(20);\n    response = _segmentCompletionMgr.extendBuildTime(params);\n    Assert.assertEquals(response.getStatus(), ControllerResponseStatus.PROCESSED);\n    Assert.assertTrue((_fsmMap.containsKey(_segmentNameStr)));\n\n    \r\n    _segmentCompletionMgr._seconds += 25;\n    params = new Request.Params().withInstanceId(S_2).withStreamPartitionMsgOffset(_s2Offset.toString())\n        .withSegmentName(_segmentNameStr);\n    response = _segmentCompletionMgr.segmentCommitStart(params);\n    Assert.assertEquals(response.getStatus(), ControllerResponseStatus.HOLD);\n    \r\n    Assert.assertFalse((_fsmMap.containsKey(_segmentNameStr)));\n    Assert.assertFalse(_commitTimeMap.containsKey(tableName));\n  }\n","date":"2021-08-21 17:02:19","endLine":1051,"groupId":"101466","id":14,"instanceNumber":2,"isCurCommit":1,"methodName":"testFailedSlowCommit","params":"()","path":"/mnt/clonedata/CloneManagementServer/ManagementServer/consistResult/result-pinot-10-0.7/blobInfo/CC_OUT/blobs/f5/2cc2d924ceea6617515aa279dcc84da724f008.src","preCode":"  public void testFailedSlowCommit()\n      throws Exception {\n    SegmentCompletionProtocol.Response response;\n    Request.Params params;\n    final String tableName = new LLCSegmentName(segmentNameStr).getTableName();\n    \r\n    final long startTime = 5;\n    segmentCompletionMgr._seconds = startTime;\n    params = new Request.Params().withInstanceId(s1).withStreamPartitionMsgOffset(s1Offset.toString())\n        .withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr.segmentConsumed(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.HOLD);\n    \r\n    segmentCompletionMgr._seconds += 1;\n    params = new Request.Params().withInstanceId(s2).withStreamPartitionMsgOffset(s2Offset.toString())\n        .withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr.segmentConsumed(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.HOLD);\n    \r\n    segmentCompletionMgr._seconds += 1;\n    params = new Request.Params().withInstanceId(s3).withStreamPartitionMsgOffset(s3Offset.toString())\n        .withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr.segmentConsumed(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.CATCH_UP);\n    verifyOffset(response, s2Offset);\n    \r\n    segmentCompletionMgr._seconds += 1;\n    params = new Request.Params().withInstanceId(s1).withStreamPartitionMsgOffset(s1Offset.toString())\n        .withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr.segmentConsumed(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.CATCH_UP);\n    \r\n    segmentCompletionMgr._seconds += 1;\n    params = new Request.Params().withInstanceId(s2).withStreamPartitionMsgOffset(s2Offset.toString())\n        .withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr.segmentConsumed(params);\n    Assert.assertEquals(response.getStatus(), SegmentCompletionProtocol.ControllerResponseStatus.COMMIT);\n    long commitTimeSec = response.getBuildTimeSeconds();\n    Assert.assertTrue(commitTimeSec > 0);\n\n    \r\n    segmentCompletionMgr._seconds = startTime + commitTimeSec - 1;\n    params = new Request.Params().withInstanceId(s2).withStreamPartitionMsgOffset(s2Offset.toString())\n        .withSegmentName(segmentNameStr).withExtraTimeSec(20);\n    response = segmentCompletionMgr.extendBuildTime(params);\n    Assert.assertEquals(response.getStatus(), ControllerResponseStatus.PROCESSED);\n    Assert.assertTrue((fsmMap.containsKey(segmentNameStr)));\n\n    \r\n    segmentCompletionMgr._seconds += 25;\n    params = new Request.Params().withInstanceId(s2).withStreamPartitionMsgOffset(s2Offset.toString())\n        .withSegmentName(segmentNameStr);\n    response = segmentCompletionMgr.segmentCommitStart(params);\n    Assert.assertEquals(response.getStatus(), ControllerResponseStatus.HOLD);\n    \r\n    Assert.assertFalse((fsmMap.containsKey(segmentNameStr)));\n    Assert.assertFalse(commitTimeMap.containsKey(tableName));\n  }\n","realPath":"pinot-controller/src/test/java/org/apache/pinot/controller/helix/core/realtime/SegmentCompletionTest.java","repoName":"pinot","snippetEndLine":0,"snippetStartLine":0,"startLine":994,"status":"M"}],"commitId":"bb34406aaa205f5c85b88c928d477fd267eda1b4","commitMessage":"@@@reformat pinot-controller (#7331)\n\n","date":"2021-08-21 17:02:19","modifiedFileCount":"151","status":"M","submitter":"Xiang Fu"}]
